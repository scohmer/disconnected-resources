name: Generate Disconnected Resources Bundle

on:
  # Run monthly on the 1st at 2 AM UTC
  schedule:
    - cron: '0 2 1 * *'

  # Run when resources-config.yaml is modified
  push:
    paths:
      - 'resources-config.yaml'
      - '.github/workflows/generate-resources.yml'

  # Allow manual trigger with optional config file input
  workflow_dispatch:
    inputs:
      config_file:
        description: 'Configuration file to use'
        required: false
        default: 'resources-config.yaml'
      custom_name:
        description: 'Custom bundle name suffix (optional)'
        required: false
        default: ''

env:
  CONFIG_FILE: ${{ github.event.inputs.config_file || 'resources-config.yaml' }}

jobs:
  generate-bundle:
    name: Generate Resources Bundle
    runs-on: ubuntu-latest
    timeout-minutes: 120

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install system dependencies
        run: |
          sudo apt-get update
          sudo apt-get install -y \
            jq \
            curl \
            wget \
            python3-pip \
            dpkg-dev \
            createrepo-c \
            docker.io

      - name: Install Python dependencies
        run: |
          pip install pyyaml

      - name: Make scripts executable
        run: |
          chmod +x scripts/*.sh
          chmod +x scripts/*.py

      - name: Validate configuration
        run: |
          python3 scripts/parse_config.py "$CONFIG_FILE" --validate-only

      - name: Parse configuration to JSON
        run: |
          python3 scripts/parse_config.py "$CONFIG_FILE" --format json --output config.json
          cat config.json

      - name: Display configuration summary
        run: |
          echo "=== Configuration Summary ==="
          echo "Environment: $(jq -r '.metadata.environment_name' config.json)"
          echo "Description: $(jq -r '.metadata.description' config.json)"
          echo ""
          echo "Enabled sources:"
          jq -r 'to_entries | map(select(.value.enabled == true)) | .[].key' config.json | sed 's/^/  - /'

      - name: Collect NPM packages
        if: success()
        run: |
          echo "=== Collecting NPM packages ==="
          bash scripts/collect_npm.sh config.json output || echo "NPM collection had warnings"

      - name: Collect PyPI packages
        if: success()
        run: |
          echo "=== Collecting PyPI packages ==="
          bash scripts/collect_pypi.sh config.json output || echo "PyPI collection had warnings"

      - name: Collect Debian packages
        if: success()
        run: |
          echo "=== Collecting Debian packages ==="
          bash scripts/collect_debian.sh config.json output || echo "Debian collection had warnings"

      # RPM collection in container to avoid conflicts with Ubuntu
      - name: Collect RPM packages
        if: success()
        run: |
          echo "=== Collecting RPM packages ==="
          RPM_ENABLED=$(jq -r '.rpm.enabled // false' config.json)
          if [ "$RPM_ENABLED" = "true" ]; then
            docker run --rm \
              -v "$(pwd)":/workspace \
              -w /workspace \
              rockylinux:9 \
              bash -c "
                dnf install -y jq createrepo_c && \
                bash scripts/collect_rpm.sh config.json output
              " || echo "RPM collection had warnings"
          else
            echo "RPM collection is disabled"
          fi

      - name: Collect container images
        if: success()
        run: |
          echo "=== Collecting container images ==="
          bash scripts/collect_containers.sh config.json output || echo "Container collection had warnings"

      - name: Collect VSCode extensions
        if: success()
        run: |
          echo "=== Collecting VSCode extensions ==="
          bash scripts/collect_vscode.sh config.json output || echo "VSCode collection had warnings"

      - name: Create bundle
        if: success()
        run: |
          echo "=== Creating bundle ==="
          bash scripts/create_bundle.sh config.json output

      - name: List generated files
        if: success()
        run: |
          echo "=== Generated files ==="
          ls -lh output/*.tar.* output/*.sha* output/*.md5 2>/dev/null || true
          echo ""
          echo "=== Bundle contents ==="
          du -sh output/bundle-staging/* 2>/dev/null || true

      - name: Generate artifact name
        id: artifact-name
        run: |
          TIMESTAMP=$(date +%Y%m%d-%H%M%S)
          CUSTOM="${{ github.event.inputs.custom_name }}"
          if [ -n "$CUSTOM" ]; then
            ARTIFACT_NAME="resources-bundle-${CUSTOM}-${TIMESTAMP}"
          else
            ARTIFACT_NAME="resources-bundle-${TIMESTAMP}"
          fi
          echo "name=$ARTIFACT_NAME" >> $GITHUB_OUTPUT
          echo "Artifact name: $ARTIFACT_NAME"

      - name: Upload bundle artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ steps.artifact-name.outputs.name }}
          path: |
            output/*.tar.*
            output/*.sha256
            output/*.sha512
            output/*.md5
            output/*-reassemble.sh
          retention-days: 90
          compression-level: 0

      - name: Generate summary
        if: success()
        run: |
          echo "## Bundle Generation Complete :rocket:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Information" >> $GITHUB_STEP_SUMMARY
          echo "- **Environment**: $(jq -r '.metadata.environment_name' config.json)" >> $GITHUB_STEP_SUMMARY
          echo "- **Timestamp**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- **Config File**: $CONFIG_FILE" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          echo "### Components Collected" >> $GITHUB_STEP_SUMMARY
          if [ -d "output/npm" ]; then
            NPM_COUNT=$(find output/npm -name "*.tgz" 2>/dev/null | wc -l || echo "0")
            echo "- **NPM**: $NPM_COUNT packages ($(du -sh output/npm 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output/pypi" ]; then
            PYPI_COUNT=$(find output/pypi/packages -type f 2>/dev/null | wc -l || echo "0")
            echo "- **PyPI**: $PYPI_COUNT packages ($(du -sh output/pypi 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output/debian" ]; then
            DEB_COUNT=$(find output/debian -name "*.deb" 2>/dev/null | wc -l || echo "0")
            echo "- **Debian**: $DEB_COUNT packages ($(du -sh output/debian 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output/rpm" ]; then
            RPM_COUNT=$(find output/rpm -name "*.rpm" 2>/dev/null | wc -l || echo "0")
            echo "- **RPM**: $RPM_COUNT packages ($(du -sh output/rpm 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output/containers" ]; then
            CONTAINER_COUNT=$(find output/containers/images -name "*.tar.gz" 2>/dev/null | wc -l || echo "0")
            echo "- **Containers**: $CONTAINER_COUNT images ($(du -sh output/containers 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi
          if [ -d "output/vscode" ]; then
            VSCODE_COUNT=$(find output/vscode/extensions -name "*.vsix" 2>/dev/null | wc -l || echo "0")
            echo "- **VSCode**: $VSCODE_COUNT extensions ($(du -sh output/vscode 2>/dev/null | cut -f1 || echo '0'))" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Bundle Files" >> $GITHUB_STEP_SUMMARY
          for file in output/*.tar.*; do
            if [ -f "$file" ]; then
              SIZE=$(du -sh "$file" | cut -f1)
              BASENAME=$(basename "$file")
              echo "- **$BASENAME**: $SIZE" >> $GITHUB_STEP_SUMMARY
            fi
          done

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download" >> $GITHUB_STEP_SUMMARY
          echo "The bundle is available as an artifact in this workflow run." >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Download the artifact from this workflow run" >> $GITHUB_STEP_SUMMARY
          echo "2. Verify checksums after download" >> $GITHUB_STEP_SUMMARY
          echo "3. Transfer to disconnected environment" >> $GITHUB_STEP_SUMMARY
          echo "4. Extract and follow README.md in bundle" >> $GITHUB_STEP_SUMMARY

      - name: Prepare email notification data
        id: email-data
        if: always()
        run: |
          # Extract email configuration
          EMAIL_ENABLED=$(jq -r '.notifications.email.enabled // false' config.json 2>/dev/null || echo "false")
          echo "email_enabled=$EMAIL_ENABLED" >> $GITHUB_OUTPUT

          if [ "$EMAIL_ENABLED" = "true" ]; then
            RECIPIENTS=$(jq -r '.notifications.email.recipients[]' config.json 2>/dev/null | tr '\n' ',' | sed 's/,$//')
            echo "recipients=$RECIPIENTS" >> $GITHUB_OUTPUT

            SEND_ON_SUCCESS=$(jq -r '.notifications.email.send_on_success // true' config.json 2>/dev/null || echo "true")
            echo "send_on_success=$SEND_ON_SUCCESS" >> $GITHUB_OUTPUT

            SEND_ON_FAILURE=$(jq -r '.notifications.email.send_on_failure // true' config.json 2>/dev/null || echo "true")
            echo "send_on_failure=$SEND_ON_FAILURE" >> $GITHUB_OUTPUT
          fi

          # Store job status
          echo "job_status=${{ job.status }}" >> $GITHUB_OUTPUT

      - name: Prepare email content
        id: email-content
        if: always() && steps.email-data.outputs.email_enabled == 'true'
        run: |
          WORKFLOW_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          TIMESTAMP=$(date -u +"%Y-%m-%d %H:%M:%S UTC")
          ENV_NAME=$(jq -r '.metadata.environment_name // "Unknown"' config.json 2>/dev/null || echo "Unknown")
          ARTIFACT_NAME="${{ steps.artifact-name.outputs.name }}"

          if [ "${{ job.status }}" = "success" ]; then
            SUBJECT="‚úÖ Disconnected Resources Bundle Ready - $ENV_NAME"
            STATUS_MESSAGE="Your disconnected resources bundle has been generated successfully!"

            # Collect statistics
            NPM_COUNT=$(find output/npm -name "*.tgz" 2>/dev/null | wc -l || echo "0")
            PYPI_COUNT=$(find output/pypi/packages -type f 2>/dev/null | wc -l || echo "0")
            DEB_COUNT=$(find output/debian -name "*.deb" 2>/dev/null | wc -l || echo "0")
            RPM_COUNT=$(find output/rpm -name "*.rpm" 2>/dev/null | wc -l || echo "0")
            CONTAINER_COUNT=$(find output/containers/images -name "*.tar.gz" 2>/dev/null | wc -l || echo "0")
            VSCODE_COUNT=$(find output/vscode/extensions -name "*.vsix" 2>/dev/null | wc -l || echo "0")

            BUNDLE_FILE=$(ls output/*.tar.* 2>/dev/null | head -1)
            if [ -n "$BUNDLE_FILE" ]; then
              BUNDLE_SIZE=$(du -sh "$BUNDLE_FILE" 2>/dev/null | cut -f1 || echo "Unknown")
            else
              BUNDLE_SIZE="Unknown"
            fi

            # Build email body
            cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background-color: #28a745; color: white; padding: 20px; text-align: center; }
              .content { padding: 20px; }
              .info-box { background-color: #f8f9fa; border-left: 4px solid #28a745; padding: 15px; margin: 15px 0; }
              .stats { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; margin: 20px 0; }
              .stat-item { background-color: #e9ecef; padding: 10px; border-radius: 5px; }
              .button { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }
              .footer { background-color: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #666; }
              table { border-collapse: collapse; width: 100%; margin: 15px 0; }
              th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
              th { background-color: #007bff; color: white; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>‚úÖ Resources Bundle Ready</h1>
            </div>
            <div class="content">
              <p>Hello,</p>
              <p><strong>$STATUS_MESSAGE</strong></p>

              <div class="info-box">
                <h3>Bundle Information</h3>
                <ul>
                  <li><strong>Environment:</strong> $ENV_NAME</li>
                  <li><strong>Bundle Name:</strong> $ARTIFACT_NAME</li>
                  <li><strong>Generated:</strong> $TIMESTAMP</li>
                  <li><strong>Total Size:</strong> $BUNDLE_SIZE</li>
                  <li><strong>Triggered By:</strong> ${{ github.actor }}</li>
                </ul>
              </div>

              <h3>üì¶ Components Collected</h3>
              <table>
                <tr>
                  <th>Component</th>
                  <th>Count</th>
                </tr>
                <tr><td>NPM Packages</td><td>$NPM_COUNT</td></tr>
                <tr><td>PyPI Packages</td><td>$PYPI_COUNT</td></tr>
                <tr><td>Debian Packages</td><td>$DEB_COUNT</td></tr>
                <tr><td>RPM Packages</td><td>$RPM_COUNT</td></tr>
                <tr><td>Container Images</td><td>$CONTAINER_COUNT</td></tr>
                <tr><td>VSCode Extensions</td><td>$VSCODE_COUNT</td></tr>
              </table>

              <h3>üì• Download Instructions</h3>
              <ol>
                <li>Visit the workflow run page</li>
                <li>Scroll to the <strong>Artifacts</strong> section at the bottom</li>
                <li>Click on <strong>$ARTIFACT_NAME</strong> to download</li>
                <li>Verify checksums after download</li>
                <li>Transfer to your disconnected environment</li>
              </ol>

              <a href="$WORKFLOW_URL" class="button">View Workflow Run</a>

              <div class="info-box">
                <h4>‚ö†Ô∏è Important Notes</h4>
                <ul>
                  <li>Artifacts are retained for 90 days</li>
                  <li>Always verify checksums after download</li>
                  <li>See the bundle README.md for installation instructions</li>
                </ul>
              </div>
            </div>
            <div class="footer">
              <p>This is an automated notification from the Disconnected Resources Pipeline</p>
              <p>Repository: ${{ github.repository }}</p>
            </div>
          </body>
          </html>
          EOF
          else
            SUBJECT="‚ùå Disconnected Resources Bundle Failed - $ENV_NAME"
            STATUS_MESSAGE="The bundle generation has failed. Please check the workflow logs."

            # Build failure email body
            cat > email_body.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
            <style>
              body { font-family: Arial, sans-serif; line-height: 1.6; color: #333; }
              .header { background-color: #dc3545; color: white; padding: 20px; text-align: center; }
              .content { padding: 20px; }
              .error-box { background-color: #f8d7da; border-left: 4px solid #dc3545; padding: 15px; margin: 15px 0; color: #721c24; }
              .button { background-color: #007bff; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; display: inline-block; margin: 10px 0; }
              .footer { background-color: #f8f9fa; padding: 15px; text-align: center; font-size: 12px; color: #666; }
            </style>
          </head>
          <body>
            <div class="header">
              <h1>‚ùå Bundle Generation Failed</h1>
            </div>
            <div class="content">
              <p>Hello,</p>

              <div class="error-box">
                <h3>Error Details</h3>
                <p><strong>$STATUS_MESSAGE</strong></p>
                <ul>
                  <li><strong>Environment:</strong> $ENV_NAME</li>
                  <li><strong>Timestamp:</strong> $TIMESTAMP</li>
                  <li><strong>Triggered By:</strong> ${{ github.actor }}</li>
                </ul>
              </div>

              <h3>üîç Next Steps</h3>
              <ol>
                <li>Review the workflow logs for detailed error messages</li>
                <li>Check if all package names and versions are correct</li>
                <li>Verify that dependencies are available</li>
                <li>Check for rate limiting or authentication issues</li>
                <li>Re-run the workflow after fixing issues</li>
              </ol>

              <a href="$WORKFLOW_URL" class="button">View Workflow Logs</a>
            </div>
            <div class="footer">
              <p>This is an automated notification from the Disconnected Resources Pipeline</p>
              <p>Repository: ${{ github.repository }}</p>
            </div>
          </body>
          </html>
          EOF
          fi

          # Save subject
          echo "$SUBJECT" > email_subject.txt
          echo "Email notification prepared"

      - name: Send success email notification
        if: success() && steps.email-data.outputs.email_enabled == 'true' && steps.email-data.outputs.send_on_success == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: file://email_subject.txt
          to: ${{ steps.email-data.outputs.recipients }}
          from: ${{ secrets.SMTP_FROM_EMAIL }}
          html_body: file://email_body.html
          ignore_cert: false
          convert_markdown: false
          priority: normal

      - name: Send failure email notification
        if: failure() && steps.email-data.outputs.email_enabled == 'true' && steps.email-data.outputs.send_on_failure == 'true'
        uses: dawidd6/action-send-mail@v3
        with:
          server_address: ${{ secrets.SMTP_SERVER }}
          server_port: ${{ secrets.SMTP_PORT }}
          username: ${{ secrets.SMTP_USERNAME }}
          password: ${{ secrets.SMTP_PASSWORD }}
          subject: file://email_subject.txt
          to: ${{ steps.email-data.outputs.recipients }}
          from: ${{ secrets.SMTP_FROM_EMAIL }}
          html_body: file://email_body.html
          ignore_cert: false
          convert_markdown: false
          priority: high

      - name: Cleanup
        if: always()
        run: |
          # Clean up intermediate files to save space
          rm -rf output/bundle-staging
          rm -f email_body.html email_subject.txt
          docker system prune -af || true
